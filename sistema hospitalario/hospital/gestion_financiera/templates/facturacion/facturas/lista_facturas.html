{% extends "base.html" %}

{% block titulo %}
  {{ titulo }}
{% endblock titulo %}

{% block content %} 
<div class="container mt-4">
  <h2 class="text-primary"><i class="bi bi-file-earmark-text"></i> Listado de Facturas</h2>
  <a href="{% url 'crear_factura' %}" class="btn btn-success mb-3">
    <i class="bi bi-plus-circle"></i> Crear Nueva Factura
  </a>
  
  <div class="table-responsive">
    <table class="table table-striped table-hover">
      <thead class="table-primary">
        <tr>
          <th>ID</th>
          <th>Paciente</th>
          <th>Fecha Emisi칩n</th>
          <th>Total</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for factura in facturas %}
        <tr>
          <td>{{ factura.id }}</td>
          <td>
            {% if factura.paciente %}
              {# 游뚿 CORRECCI칍N CLAVE: Usar 'nombre' directamente. ELIMINAMOS 'nombre_completo' #}
              {{ factura.paciente.nombre }}
            {% else %}
              N/A
            {% endif %}
          </td>
          <td>{{ factura.fecha_emision|date:"Y-m-d H:i" }}</td>
          <td>$ {{ factura.total|floatformat:2|default:0.00 }}</td>
          <td>
            <span class="badge bg-{% if factura.estado == 'Pagada' %}success{% elif factura.estado == 'Pendiente' %}warning{% else %}danger{% endif %}">
              {# Se corrigi칩 la l칩gica para usar 'Pagada' y 'Pendiente' seg칰n tu modelo #}
              {{ factura.estado }}
            </span>
          </td>
          <td class="text-nowrap">
            <a href="{% url 'detalle_factura' factura.pk %}" class="btn btn-info btn-sm">
              <i class="bi bi-eye"></i> Ver / Editar
            </a>
                        
                        {# 游뚿 NUEVO BOT칍N DE ELIMINAR (Solo si no est치 Pagada) #}
                        {% if factura.estado != 'Pagada' %}
                            <a href="{% url 'eliminar_factura' factura.pk %}" 
                               class="btn btn-danger btn-sm"
                               onclick="return confirm('쮼st치 seguro de que desea eliminar la Factura #{{ factura.pk }}?');"
                               title="Eliminar Factura">
                                <i class="bi bi-trash"></i> Eliminar
                            </a>
                        {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="6" class="text-center">No hay facturas registradas.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock content %}