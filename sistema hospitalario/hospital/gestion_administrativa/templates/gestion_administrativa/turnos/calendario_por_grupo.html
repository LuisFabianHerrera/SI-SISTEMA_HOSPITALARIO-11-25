{% extends "base.html" %}
{% load diccionario %}

{% block title %}Calendario de Turnos{% endblock %}

{% block content %}
<div class="container mt-4">

    <!-- TÍTULO -->
    <h2 class="mb-4 text-center fw-bold text-primary">
        <i class="bi bi-calendar-week"></i> Calendario de Turnos - {{ departamento }} - {{ grupo }}
    </h2>

    <!-- NAVEGACIÓN DE MESES -->
    <div class="d-flex justify-content-between mb-3">
        <a href="?year={{ prev_year }}&month={{ prev_month }}" class="btn btn-secondary">← Mes anterior</a>
        <span class="fw-bold fs-5">{{ month }}/{{ year }}</span>
        <a href="?year={{ next_year }}&month={{ next_month }}" class="btn btn-secondary">Mes siguiente →</a>
    </div>

    <div class="table-responsive">
        <table class="table table-bordered tabla-turnos text-center align-middle">
            <thead class="table-dark">
                <tr>
                    <th class="empleado-col">Empleado</th>
                    {% for fecha in fechas_mes %}
                        <th {% if fecha == dia_actual %}class="hoy"{% endif %}>
                            {{ fecha|date:"d M" }}
                        </th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
            {% for emp in empleados %}
                <tr>
                    <td class="empleado-col fw-bold bg-light">{{ emp.nombre }}</td>
                    
                    {% for fecha in fechas_mes %}
                        {% with t=turnos_empleados|dictget:emp.id|dictget:fecha %}
                            <td class="{% if grupo == 'Grupo 1' %}bg-g1{% elif grupo == 'Grupo 2' %}bg-g2{% elif grupo == 'Grupo 3' %}bg-g3{% endif %} {% if fecha == dia_actual %}hoy{% endif %}">
                                <div>{{ t.horario }}</div>

                                {% if t.turno_id %}
                                    <a href="{% url 'editar_turno' t.turno_id %}?fecha={{ fecha|date:'Y-m-d' }}" 
                                       class="btn btn-sm btn-primary mt-1">Editar</a>
                                    <a href="{% url 'eliminar_turno' t.turno_id %}" 
                                       class="btn btn-sm btn-danger mt-1"
                                       onclick="return confirm('¿Seguro quieres eliminar este turno?')">Eliminar</a>
                                {% else %}
                                    {% if t.horario != "Descanso" %}
                                        <a href="{% url 'registrar_turno' %}?empleado={{ emp.id }}&fecha={{ fecha|date:'Y-m-d' }}" 
                                           class="btn btn-sm btn-success mt-1">Agregar</a>
                                    {% endif %}
                                {% endif %}
                            </td>
                        {% endwith %}
                    {% endfor %}
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- BOTÓN VOLVER -->
    <div class="mt-3 text-center">
        <a href="{% url 'lista_turnos' %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left-circle"></i> Volver a Departamentos
        </a>
    </div>
</div>

<style>
    td.empleado-col {
        width: 160px;
    }
    td.bg-g1 { background-color: #f8d7da; }
    td.bg-g2 { background-color: #d1ecf1; }
    td.bg-g3 { background-color: #fff3cd; }
    td.hoy {
        background-color: #ffecb3 !important;
        font-weight: bold;
        border-radius: 4px;
    }
    a.btn { display: block; margin: 4px auto 0; }
</style>
{% endblock %}
